# stClinic

*stClinic predicts clinically relevant tumor microenvironments using spatial omics data.*

![image](https://github.com/JunjieXia14/stClinic/blob/main/image/Overview.png)

## Overview

stClinic is a tool for predicting clinically relevant tumor microenvironments from spatial omics data.

**a.** Given omics profiles (*X*) and spatial location (*S*) data across multiple slices as the input, stClinic is able to learn batch-corrected features (*z*) in unsupervised manner, and predict clinically relevant TMEs under supervision of clinical information (*Y*). **b.** stClinic utilizes a VGAE (consisting of a GAT encoder and *L* one-layer slice specific decoders) to transform *X* and a unified graph (including both intra-edges for spatially nearest spots within each slice and inter-edges for omics-similar spots across different slices) into latent features (*z*) on the GMM manifold, and repeatedly removes associations between any two spots from different GMM components to eliminate impact of false positive relations between them. **c.** stClinic adopts six statistical measures in two-dimensional UMAP space to quantify the $k_{th}$ cluster, and fuses them to characterize the representations of the $i_{th}$ slice ($r_{i}$) using attention, then learns the weight ($W^T$) of different clusters on clinical outcomes from a FC layer with SoftMax or Cox layer under supervision of sample labels. **d.** The joint low-dimensional features *z* and weight ($W^T$) of different clusters on clinical outcomes can be used for visualization, data denoising, identifing slice-specific TMEs, and predicting condition-specific TME.

## Installation

Installation was tested on Ubuntu 22.10 with Python 3.8.17, Scanpy 1.9.3, PyTorch 1.12.0, and PyG (PyTorch Geometric) 2.3.0 on a machine with one 40-core Intel(R) Xeon(R) Silver 4210R CPU addressing with 128GB RAM, and one NVIDIA A800 GPU addressing 80GB. Please run stClinic on CUDA if possible.

### 1. Grab source code of stClinic

```bash
git clone https://github.com/JunjieXia14/stClinic.git
cd stClinic-main
```

### 2. Install stClinic in the virtual environment by conda

* Firstly, install conda: https://docs.anaconda.com/anaconda/install/index.html
* Then, automatically install all used packages (described by "environment.yml") for stClinic in a few mins.

```bash
conda config --set channel_priority strict
conda env create -f environment.yml
conda activate stClinic
```

Other software dependencies are listed in "requirements.txt".

## Quick start

### Unsupervised stClinic for integrating multiple slices

#### Input

Take the human dorsolateral prefrontal cortex (DLPFC) dataset of 10X Visium (four slices: 151673-151676) generated by Maynard et al. (*Nature Neuroscience*, 2021) as an example input, which includes three types of files: (1) gene expression data, (2) spatial location data, and (3) annotation labels for each spot. These input files are available at `Datasets/README.md`.

#### Run

Run the following command under the directory `Tutorials/code` in Linux Bash Shell:

```bash
cd Tutorials/code
python DLPFC_Unsupervised_Integration.py
```

This script automatically (1) loads the input data as an concatenated `AnnData` object, (2) constructs an unified graph based on spatial location and omics similarity, (3) learns batch-corrected features of four slices by stClinic in an unsupervised manner, and (4) identifies spatial domains according to the joint embeddings by `mclust` algorithm.

**Hyperparameters**

* R / rpy2 workpath: defines the work path of your R software and rpy2 package.
* used_device: defines the gpu index for training stClinic. The default value is 'cuda:0'.
* input_dir: defines the directory of input data files.
* path: defines the directory of output data files. The default value is './DLPFC'.
* rad_cutoff / k_cutoff: defines the radius value used in the construction of the intra-edges (according to spatial location data) for each slice. And the k_cutoff defines the number of spatial neighbors when using 'KNN' method for the construction of the intra-edges, with a default value of 6.
* n_top_genes: defines the number of highly variable genes to select for each slice. The default value is 5000, and this value can be larger than the default value for the large dataset with multiple slices (e.g., 18000 highly variable genes for CRCLM dataset).
* k: defines the number of nearest neighbors in other slices when using 'MNN' method for the construction of the inter-edges (based on omics similarity) for each slice. In the heterogeneous tissues like tumors, the value is set to 5, and in spatial multi-omics tissues, the value is set to 10, while in relatively homogeneous tissues, the value is 1 or 0.
* n_centroids: defines the number of components of GMM prior distribution.
* lr: defines learning rate parameter for learning batch-corrected embeddings of multiple slices by unsupervised stClinic. The default value of the parameter is 0.0005, and can be empirically set to the 1-20 folds (0.0005/20 - 0.0005) of this default value in different datasets.

#### Output

An concatenated `AnnData` object with stClinic embeddings and UMAP coordinates of four slices stored in `AnnData.obsm`, and spatial cluster labels stored in `AnnData.obs.mclust`.

### Supervised stClinic for predicting clinically relevant TMEs

#### Input

#### Run

#### Output

## More tutorials

Three more detailed tutorials and further visualization are introduced in the `Tutorials/notebook` folder to demonstrate how to implement stClinic:

* Tutorial 1: Integrating 4 DLPFC slices of homogeneous tissue.
* Tutorial 2: Integrating 2 breast cancer slices of heterogeneous tissues.
* Tutorial 3: Predicting metastasis-related TMEs from integrated colorectal cancer and liver metastasis slices.

## References

* stMVC: https://github.com/cmzuo11/stMVC
* STAligner: https://github.com/zhoux85/STAligner
* CellCharter: https://github.com/CSOgroup/cellcharter
* CytoCommunity: https://github.com/huBioinfo/CytoCommunity
* PathFinder: https://github.com/Biooptics2021/PathFinder

## Citation

stClinic predicts clinically relevant tumor microenvironments using spatial omics data.
